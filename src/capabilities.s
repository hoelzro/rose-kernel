FEATURE_FLAGS          EQU 0x01
EXTENDED_FEATURE_FLAGS EQU 0x80000001

PSE_PRESENT      EQU 1<<3
PAE_PRESENT      EQU 1<<6
APIC_PRESENT     EQU 1<<9
LONGMODE_ENABLED EQU 1<<29

; XXX verify that the CPU supports CPUID!

; name, EAX_VALUE, REG, BIT
%MACRO GEN_CAPS 4
GLOBAL %1
%1:
    PUSH EBX
    PUSH ECX
    PUSH EDX

    MOV EAX, %2
    CPUID

    MOV EAX, 0
    AND %3, %4
    SETNZ AL

    POP EDX
    POP ECX
    POP EBX

    RET
%ENDMACRO

GEN_CAPS capabilities_is_64bit, EXTENDED_FEATURE_FLAGS, EDX, LONGMODE_ENABLED
GEN_CAPS capabilities_has_apic, FEATURE_FLAGS, EDX, APIC_PRESENT
GEN_CAPS capabilities_has_pae, FEATURE_FLAGS, EDX, PAE_PRESENT
GEN_CAPS capabilities_has_pse, FEATURE_FLAGS, EDX, PSE_PRESENT
